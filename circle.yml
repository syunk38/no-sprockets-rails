machine:
  timezone:
    Asia/Tokyo
  ruby:
    version: 2.3.0
  node:
    version: 6.9.1

dependencies:
  cache_directories:
    - "vendor/bundle"
    - "node_modules"

  override:
    - rm Gemfile.lock
    - bundle install --path vendor/bundle

test:
  override:
    - echo "Nothing to do here"
database:
  override:
    - echo "Nothing to do here"


deployment:
  production:
    branch: master
    commands:
      - "[[ ! -s \"$(git rev-parse --git-dir)/shallow\" ]] || git fetch --unshallow"
      - npm install
      - npm rebuild node-sass
      - npm run build
      - git branch --contains
      - git checkout $CIRCLE_SHA1
      - git config --global user.email $HEROKU_EMAIL
      - git config --global user.name $HEROKU_USER_NAME
      - git add public/.
      - git add app/views/webpack-assets.json
      - git commit -m 'asset build'
      - git status
      - git push git@heroku.com:no-sprockets-rails.git $CIRCLE_SHA1:refs/heads/master
      - heroku run rake db:migrate --app no-sprockets-rails:
          timeout: 400 # if your deploys take a long time
